# üéØ Perbaikan Parser API untuk Integrasi ASIK

## üìù Ringkasan Perubahan

Parser API telah diperbaiki untuk menyediakan **semua data yang dibutuhkan** oleh aplikasi ASIK untuk manajemen stok dan item yang lengkap.

## ‚ú® Data Baru yang Ditambahkan

### 1. **Metadata Invoice** (Baru!)

Sekarang API mengembalikan informasi lengkap tentang invoice:

```json
{
  "metadata": {
    "invoice_number": "04002500373856589",
    "invoice_date": "06 November 2025",
    "supplier_name": "SAUDARA PRATAMA",
    "supplier_npwp": "0021057187122000",
    "buyer_name": "ANUGERAH TEMAN SETIA",
    "buyer_npwp": "0637531807118000"
  }
}
```

**Kegunaan:**

- Tracking invoice yang akurat
- Informasi supplier untuk referensi
- Tanggal invoice untuk laporan historis

### 2. **Detail Item Lengkap** (Diperbaiki!)

Setiap item sekarang menyertakan semua informasi penting:

#### Data Lama (Sebelum Perbaikan):

```json
{
  "no": 1,
  "nama_barang": "LENCANA MERAH",
  "total_raw": "23.331.081,00",
  "total": 23331081.0
}
```

#### Data Baru (Setelah Perbaikan):

```json
{
  "no": 1,
  "item_code": "000000",
  "nama_barang": "LENCANA MERAH",
  "quantity": 150.0,
  "unit": "Lainnya",
  "unit_price": 155540.54,
  "unit_price_formatted": "Rp 155.540,54",
  "discount": 4617117.0,
  "discount_formatted": "Rp 4.617.117,00",
  "total_raw": "23.331.081,00",
  "total": 23331081.0,
  "total_formatted": "Rp 23.331.081,00"
}
```

**Data Baru yang Ditambahkan:**

- ‚úÖ **`item_code`** - Kode barang dari PDF
- ‚úÖ **`quantity`** - Jumlah/stok barang (PENTING untuk manajemen stok!)
- ‚úÖ **`unit`** - Satuan (PCS, KG, Lainnya, dll)
- ‚úÖ **`unit_price`** - Harga per unit
- ‚úÖ **`discount`** - Potongan harga
- ‚úÖ **Formatted fields** - Format rupiah yang mudah dibaca

## üîç Perbandingan Lengkap

### Sebelum Perbaikan

```json
{
  "status": "success",
  "filename": "invoice.pdf",
  "items": [
    {
      "no": 1,
      "nama_barang": "LENCANA MERAH",
      "total": 23331081.0
    }
  ],
  "validation": { ... }
}
```

**Masalah:**

- ‚ùå Tidak ada informasi stok/quantity
- ‚ùå Tidak ada harga per unit
- ‚ùå Tidak ada informasi invoice
- ‚ùå Tidak ada informasi supplier
- ‚ùå Item code tidak tersedia

### Setelah Perbaikan

```json
{
  "status": "success",
  "filename": "invoice.pdf",
  "metadata": {
    "invoice_number": "04002500373856589",
    "invoice_date": "06 November 2025",
    "supplier_name": "SAUDARA PRATAMA",
    "supplier_npwp": "0021057187122000",
    "buyer_name": "ANUGERAH TEMAN SETIA",
    "buyer_npwp": "0637531807118000"
  },
  "items": [
    {
      "no": 1,
      "item_code": "000000",
      "nama_barang": "LENCANA MERAH",
      "quantity": 150.0,
      "unit": "Lainnya",
      "unit_price": 155540.54,
      "discount": 4617117.0,
      "total": 23331081.0
    }
  ],
  "validation": { ... }
}
```

**Solusi:**

- ‚úÖ Quantity untuk manajemen stok otomatis
- ‚úÖ Unit price untuk kalkulasi harga
- ‚úÖ Invoice metadata lengkap
- ‚úÖ Informasi supplier tersedia
- ‚úÖ Item code dari PDF

## üì¶ Integrasi dengan ASIK

### Update yang Diperlukan di `CoretaxParserService.php`

File: `/Users/user/Project/ASIK/app/Services/CoretaxParserService.php`

**Method `processItems()` perlu diupdate** untuk menggunakan data baru:

```php
private function processItems(array $result, float $margin): array
{
    $items = [];
    $filename = $result['filename'] ?? 'unknown.pdf';
    $metadata = $result['metadata'] ?? [];

    // Extract invoice number dari metadata atau filename
    $invoiceNumber = $metadata['invoice_number'] ?? $this->extractInvoiceNumber($filename);

    foreach ($result['items'] as $item) {
        // Gunakan unit_price jika tersedia, fallback ke total
        $unitPrice = $item['unit_price'] ?? 0;
        $quantity = $item['quantity'] ?? 1;
        $buyPrice = $item['total'] ?? ($unitPrice * $quantity);

        // Hitung harga jual dengan margin
        $sellPrice = $buyPrice + ($buyPrice * $margin / 100);
        $profit = $sellPrice - $buyPrice;

        // Gunakan item_code dari PDF jika ada
        $itemCode = $item['item_code'] ?? null;
        if ($itemCode === '000000' || empty($itemCode)) {
            $itemCode = null; // Will be generated by system
        }

        $items[] = [
            'item' => [
                'name' => $item['nama_barang'] ?? 'Unknown Item',
                'item_code' => $itemCode,
                'buy_price' => $buyPrice,
                'margin' => $margin,
                'sell_price' => $sellPrice,
                'profit' => $profit,
                'stock' => (int) $quantity, // üéØ PENTING: Gunakan quantity sebagai stock!
                'initial_stock' => (int) $quantity,
                'unit_price' => $unitPrice,
                'unit' => $item['unit'] ?? 'PCS',
                'discount' => $item['discount'] ?? 0,
                'original_tax_invoice_file_name' => $filename,
                'tax_invoice_number' => $invoiceNumber,
                'invoice_date' => $metadata['invoice_date'] ?? null,
                'supplier_name' => $metadata['supplier_name'] ?? null,
                'supplier_npwp' => $metadata['supplier_npwp'] ?? null,
                'is_free_ppn' => false,
            ]
        ];
    }

    return $items;
}
```

## üéØ Manfaat untuk ASIK

### 1. **Manajemen Stok Otomatis**

- Sekarang quantity diambil langsung dari PDF
- Tidak lagi default ke stock = 1
- Stock akurat sesuai faktur pajak

### 2. **Harga yang Lebih Akurat**

- Unit price tersedia untuk perhitungan
- Margin bisa dihitung dengan benar
- Discount tercatat untuk referensi

### 3. **Tracking Invoice Lengkap**

- Nomor invoice dari PDF (bukan filename)
- Tanggal invoice untuk laporan historis
- Informasi supplier untuk referensi

### 4. **Data Lebih Kaya**

- Item code dari PDF (jika ada)
- Unit/satuan barang
- Potongan harga tercatat

## üöÄ Cara Menggunakan

### 1. Update Parser API

Parser API sudah diperbaiki di:

- `/Users/user/Project/CoretaxDataParser-API/parser.py`

### 2. Test Parser

```bash
cd /Users/user/Project/CoretaxDataParser-API
python3 test_improved_parser.py
```

### 3. Update Service ASIK

Copy method `processItems()` yang baru ke:

- `/Users/user/Project/ASIK/app/Services/CoretaxParserService.php`

Atau lihat referensi lengkap di:

- `/Users/user/Project/CoretaxDataParser-API/IMPROVED_SERVICE_METHOD.php`

### 4. Restart API Server

```bash
cd /Users/user/Project/CoretaxDataParser-API
uvicorn api:app --host 0.0.0.0 --port 9000 --reload
```

## üìä Contoh Response Lengkap

### Single File Parse

```json
{
  "status": "success",
  "filename": "InputTaxInvoice-xxx.pdf",
  "metadata": {
    "invoice_number": "04002500373856589",
    "invoice_date": "06 November 2025",
    "supplier_name": "SAUDARA PRATAMA",
    "supplier_npwp": "0021057187122000",
    "buyer_name": "ANUGERAH TEMAN SETIA",
    "buyer_npwp": "0637531807118000"
  },
  "items": [
    {
      "no": 1,
      "item_code": "000000",
      "nama_barang": "LENCANA MERAH",
      "quantity": 150.0,
      "unit": "Lainnya",
      "unit_price": 155540.54,
      "unit_price_formatted": "Rp 155.540,54",
      "discount": 4617117.0,
      "discount_formatted": "Rp 4.617.117,00",
      "total_raw": "23.331.081,00",
      "total": 23331081.0,
      "total_formatted": "Rp 23.331.081,00"
    },
    {
      "no": 2,
      "item_code": "000000",
      "nama_barang": "CAKRA KEMBAR",
      "quantity": 250.0,
      "unit": "Lainnya",
      "unit_price": 201801.8,
      "unit_price_formatted": "Rp 201.801,80",
      "discount": 0.0,
      "discount_formatted": "Rp 0,00",
      "total_raw": "50.450.450,00",
      "total": 50450450.0,
      "total_formatted": "Rp 50.450.450,00"
    }
  ],
  "total_items": 2,
  "validation": {
    "calculated_total": 73781531.0,
    "calculated_total_formatted": "Rp 73.781.531,00",
    "pdf_total": 73781531.0,
    "pdf_total_formatted": "Rp 73.781.531,00",
    "is_valid": true,
    "difference": 0.0,
    "difference_formatted": "Rp 0,00"
  }
}
```

## ‚úÖ Testing Checklist

- [x] Parser mengekstrak metadata invoice
- [x] Parser mengekstrak quantity/stok item
- [x] Parser mengekstrak unit price
- [x] Parser mengekstrak satuan (unit)
- [x] Parser mengekstrak item code
- [x] Parser mengekstrak discount
- [x] Format rupiah tersedia
- [ ] Test dengan multiple PDFs
- [ ] Update ASIK service
- [ ] Integration test ASIK + API

## üìù Catatan Penting

1. **Backward Compatible**: API masih mengembalikan field lama (`total`, `nama_barang`, dll) jadi aplikasi yang sudah ada tidak akan rusak.

2. **Quantity = Stock**: Field `quantity` dari PDF langsung bisa digunakan sebagai `stock` di ASIK.

3. **Item Code**: Jika item code dari PDF adalah "000000" atau kosong, biarkan null supaya system ASIK generate kode otomatis.

4. **Metadata Optional**: Semua field metadata adalah optional (menggunakan null coalescing) supaya tidak error jika data tidak tersedia.

5. **Format Fields**: Tersedia format rupiah (`_formatted`) untuk display, tapi tetap ada raw number untuk kalkulasi.

## üêõ Known Issues & Edge Cases

1. **Format Tanggal**: Parser menangani beberapa format tanggal (DD Month YYYY, DD-MM-YYYY, DD/MM/YYYY)
2. **Unit Variations**: Unit bisa "PCS", "Lainnya", "KG", dll - tergantung PDF
3. **Discount**: Discount diambil dari baris "Potongan Harga", bisa 0 jika tidak ada
4. **Item Code**: Banyak PDF menggunakan "000000" sebagai generic code

## üìû Support

Jika ada masalah:

1. Test parser dengan: `python3 test_improved_parser.py`
2. Cek log Laravel: `tail -f storage/logs/laravel.log`
3. Cek API health: `curl http://localhost:9000/health`

---

**Version:** 2.0.0  
**Last Updated:** 2 February 2026  
**Changes:** Added quantity, unit_price, unit, discount, metadata extraction
